(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(s){if(s.ep)return;s.ep=!0;const t=o(s);fetch(s.href,t)}})();const B=document.getElementById("hour_ent");for(let e=1;e<=12;e++){const n=document.createElement("option");n.value=e,n.textContent=e,B.appendChild(n)}const D=document.getElementById("hour_ext");for(let e=1;e<=12;e++){const n=document.createElement("option");n.value=e,n.textContent=e,D.appendChild(n)}const M=document.getElementById("lineDropdown_ent"),h=document.getElementById("stationDropdown_ent"),T=document.getElementById("lineDropdown_ext"),y=document.getElementById("stationDropdown_ext");M.addEventListener("change",function(){const e=this.value.toLowerCase();if(!e){h.innerHTML='<option value="">-- Select a station --</option>';return}const n=`stop_data/${e}_line_stops.csv`;fetch(n).then(o=>o.text()).then(o=>{const a=o.trim().split(`
`),t=a[0].split(",").indexOf("STATION_NAME");if(t===-1){console.error("STATION_NAME column not found");return}h.innerHTML='<option value="">-- Select a station --</option>',a.slice(1).forEach(i=>{const l=i.split(",")[t],c=document.createElement("option");c.value=l,c.textContent=l,h.appendChild(c)})}).catch(o=>{console.error("Error loading CSV:",o)})});T.addEventListener("change",function(){const e=this.value.toLowerCase();if(!e){y.innerHTML='<option value="">-- Select a station --</option>';return}const n=`stop_data/${e}_line_stops.csv`;fetch(n).then(o=>o.text()).then(o=>{const a=o.trim().split(`
`),t=a[0].split(",").indexOf("STATION_NAME");if(t===-1){console.error("STATION_NAME column not found");return}y.innerHTML='<option value="">-- Select a station --</option>',a.slice(1).forEach(i=>{const l=i.split(",")[t],c=document.createElement("option");c.value=l,c.textContent=l,y.appendChild(c)})}).catch(o=>{console.error("Error loading CSV:",o)})});function w(e,n,o){const a=L.map("map").setView([n[0],n[1]],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(a),e.forEach(t=>{L.circleMarker([+t.latitude,+t.longitude],{radius:3,color:t.color,fillColor:t.color,fillOpacity:1,weight:1}).bindPopup(`${t.name}<br>${t.date_of_occurrence}`).addTo(a)}),console.log(e);const s=L.icon({iconUrl:"train_marker.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});L.marker([n[0],n[1]],{icon:s}).addTo(a),document.getElementById("map").style.display="flex"}function S(){const e=x.every(n=>n.value&&!n.value.includes("Select"));v.disabled=!e}function C(e){const[n,o]=e.trim().split(" "),[a,s]=n.split(":");let t=parseInt(a);const i=parseInt(s);o==="PM"&&t!==12&&(t+=12),o==="AM"&&t===12&&(t=0);const d=new Date;return d.setHours(t,i,0,0),d}function F(e){const n=e.split("T")[1],[o,a,s]=n.split(":"),t=new Date;return t.setHours(parseInt(o),parseInt(a),0,0),t}function E(e,n,o,a){const s=u=>u*Math.PI/180,i=s(e),d=s(n),l=s(o),c=s(a),m=Math.sin(i/2)**2+Math.cos(l)*Math.cos(c)*Math.sin(d/2)**2;return 3958.8*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))}function N(e,n){let o=[];e.forEach(l=>{const c=parseFloat(l[n]);isNaN(c)||o.push(c)});const a=o.length;if(a===0)return{mean:null,stdDev:null};const t=o.reduce((l,c)=>l+c,0)/a,i=o.reduce((l,c)=>l+Math.pow(c-t,2),0)/a,d=Math.sqrt(i);return{mean:parseFloat(t.toFixed(2)),stdDev:parseFloat(d.toFixed(2))}}function A(e,n,o){return(e-n)/(o-n)}function O(e){e=Math.max(0,Math.min(1,e));const n=Math.round(139+e*72),o=Math.round(0+e*211),a=Math.round(0+e*211);return`rgb(${n},${o},${a})`}async function $(e,n){try{return await new Promise((a,s)=>{Papa.parse(e,{download:!0,header:!0,dynamicTyping:!0,complete:function(t){const i=t.data;console.log("Line CSV loaded:",i);const d=i.find(l=>l.STATION_NAME==n);return console.log(d),a(d?[d.latitude,d.longitude]:[0,0])},error:function(t){s(t)}})})}catch(o){return console.error("Error loading CSV:",o),[0,0]}}async function P(e,n){try{return await new Promise((a,s)=>{Papa.parse("chicago_crime_data.csv",{download:!0,header:!0,dynamicTyping:!0,complete:function(t){const i=t.data;console.log("Crime Data CSV loaded:",i);let d=i.filter(r=>{const u=parseFloat(r.latitude),p=parseFloat(r.longitude),f=r.date_of_occurrence;if(isNaN(u)||isNaN(p)||!f)return!1;const g=e[0]-u,_=e[1]-p;return E(g,_,e[0],u)<=1}).map(r=>{const u=parseFloat(r.latitude),p=parseFloat(r.longitude),f=e[0]-u,g=e[1]-p;r.distance_diff=parseFloat(E(f,g,e[0],u).toFixed(2)*10);const _=Math.abs(F(r.date_of_occurrence)-n);return r.time_diff=parseFloat((_/36e5).toFixed(2)),r.rel_score=r.distance_diff+r.time_diff,r});console.log("updated rows",d);const l=N(d,"rel_score");console.log("rel_score stats: ",l.mean,l.stdDev);let c=100,m=-100;d.map(r=>{r.z_score=(r.rel_score-l.mean)/l.stdDev,r.z_score<c?c=r.z_score:r.z_score>m&&(m=r.z_score)}),console.log("z score extremes: ",c,m),d.map(r=>{const u=A(r.z_score,c,m);r.color=O(u)}),a(d)},error:function(t){s(t)}})})}catch(o){return console.error("Error loading CSV:",o),""}}async function I(e){const n=C(e.time),o=e.line.toLowerCase(),a=e.station,s=`stop_data/${o}_line_stops.csv`;console.log(s);const t=await $(s,a);return console.log(t[0],t[1]),console.log(n),{crime_data:await P(t,n),coordinates:t}}const v=document.getElementById("submitBtn"),x=[document.getElementById("lineDropdown_ent"),document.getElementById("stationDropdown_ent"),document.getElementById("hour_ent"),document.getElementById("minute_ent"),document.getElementById("ampm_ent"),document.getElementById("lineDropdown_ext"),document.getElementById("stationDropdown_ext"),document.getElementById("hour_ext"),document.getElementById("minute_ext"),document.getElementById("ampm_ext")];x.forEach(e=>e.addEventListener("change",S));v.addEventListener("click",async()=>{document.getElementById("form-container").style.display="none",document.getElementById("submitBtn").style.display="none",document.getElementById("loading-screen").style.display="flex";const e={entering:{line:document.getElementById("lineDropdown_ent").value,station:document.getElementById("stationDropdown_ent").value,time:`${document.getElementById("hour_ent").value}:${document.getElementById("minute_ent").value} ${document.getElementById("ampm_ent").value}`},exiting:{line:document.getElementById("lineDropdown_ext").value,station:document.getElementById("stationDropdown_ext").value,time:`${document.getElementById("hour_ext").value}:${document.getElementById("minute_ext").value} ${document.getElementById("ampm_ext").value}`}};try{const n=await I(e.entering),o=await I(e.exiting);console.log("Enter Rows:",n),console.log("Exit Rows:",o),document.getElementById("map").style.display="block",w(n.crime_data,n.coordinates,"left"),setTimeout(()=>{map.invalidateSize()},1e3)}catch(n){console.error("Error generating rows:",n)}finally{document.getElementById("loading-screen").style.display="none"}});
